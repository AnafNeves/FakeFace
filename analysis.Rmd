---
title: "Face Attractiveness and the Sense of Reality"
output: html_document
date: "`r Sys.Date()`"
editor_options: 
  chunk_output_type: console
---

```{r, echo = FALSE, warning=FALSE, message=FALSE}
options(
  digits = 3,
  mc.cores = 4,
  brms.algorithm = "sampling",
  brms.backend = "cmdstanr"
)

cache <- TRUE
runModels <- FALSE
bestModels <- FALSE
fig.width <- see::golden_ratio(7)
fig.height <- 7

knitr::opts_chunk$set(
  collapse = TRUE,
  dpi = 450,
  fig.path = "./figures/",
  fig.width = fig.width,
  fig.height = fig.height
)
```


# Introduction

The goal of this study was to...

# Methods


```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(ggdist)
library(ggside)
library(easystats)
library(patchwork)
library(brms)

df <- read.csv("data/data.csv")
# |>
#   mutate(
#     Date = lubridate::dmy(Date),
#     Participant = fct_reorder(Participant, Date),
#     Screen_Refresh = as.character(Screen_Refresh),
#     Illusion_Side = as.factor(Illusion_Side),
#     # Illusion_Effect = fct_relevel(as.factor(Illusion_Effect), "Incongruent", "Null", "Congruent"),
#     Illusion_Effect = fct_relevel(as.factor(Illusion_Effect), "Incongruent", "Congruent"),
#     Block = as.factor(Block),
#     Education = fct_relevel(Education, "Doctorate", "Master", "Bachelor", "High School", "Other")
#   )
```



## Exclusions {.tabset}

```{r message=FALSE, warning=FALSE}
outliers <- c()
```

We removed `r length(outliers)` participants upon inspection of...

### Attention Checks

```{r message=FALSE, warning=FALSE}
dfsub <- df |>
  group_by(Participant) |>
  select(Participant, starts_with("Attention")) |>
  slice(1) |>
  ungroup() |>
  mutate(Attention_Check = mean(c(Attention_Check1, Attention_Check2, Attention_Check3))) |>
  arrange(Attention_Check)
```

### Duration

```{r message=FALSE, warning=FALSE}

```

### Ratings

```{r message=FALSE, warning=FALSE}
dfsub$Cor_Trustworthy <- NA
dfsub$Cor_Attractive <- NA
for (participant in dfsub$Participant) {
  dfsub[dfsub$Participant == participant, "Cor_Trustworthy"] <- cor(df[df$Participant == participant, "Trustworthy"], df[df$Participant == participant, "Norms_Trustworthy"])
  dfsub[dfsub$Participant == participant, "Cor_Attractive"] <- cor(df[df$Participant == participant, "Attractive"], df[df$Participant == participant, "Norms_Attractive"])
}
```

```{r message=FALSE, warning=FALSE}
data.frame(Participant = c("Total"), t(sapply(dfsub[2:ncol(dfsub)], mean, na.rm = TRUE))) |>
  rbind(dfsub) |>
  knitr::kable() |>
  kableExtra::row_spec(1, italic = TRUE) |>
  kableExtra::row_spec(which(dfsub$Participant %in% outliers) + 1, background = "#EF9A9A")
```

### Manipulation Check

```{r message=FALSE, warning=FALSE}
df |>
  mutate(Participant = fct_relevel(Participant, group_by(df, Participant) |>
    summarize(Real = mean(Real)) |>
    ungroup() |>
    arrange(Real) |>
    pull(Participant))) |>
  ggplot(aes(x = Real, y = Participant, fill = Participant)) +
  ggdist::stat_slab(scale = 2, slab_alpha = 0.9) +
  geom_vline(xintercept = 0, linetype = "dotted") +
  scale_y_discrete(expand = c(1, 1)) +
  scale_x_continuous(
    limits = c(-100, 100),
    expand = c(0.01, 0.01),
    breaks = c(-100, 0, 100),
    label = c("Fake", "0", "Real")
  ) +
  scale_fill_viridis_d() +
  labs(x = "Simulation Monitoring", y = "Participants", title = "Distribution of Reality Judgments") +
  guides(fill = "none") +
  see::theme_modern() +
  theme(
    axis.text.y = element_blank(),
    plot.title = element_text(face = "bold", hjust = 0.5)
  )
```


## Participants

```{r message=FALSE, warning=FALSE}
dfsub <- df |>
  group_by(Participant) |>
  select(Participant, Age, Sex, Sexual_Orientation, Ethnicity, Education, Nationality, Device_OS, starts_with("Screen")) |>
  slice(1) |>
  ungroup()
```

The final sample included `r report::report_participants(dfsub, age="Age", sex="Sex")`.

```{r }
plot_distribution <- function(dfsub, what = "Age", title = what, subtitle = "", fill = "orange") {
  dfsub |>
    ggplot(aes_string(x = what)) +
    geom_density(fill = fill) +
    geom_vline(xintercept = mean(dfsub[[what]]), color = "red", linetype = "dashed") +
    scale_x_continuous(expand = c(0, 0)) +
    scale_y_continuous(expand = c(0, 0)) +
    ggtitle(title, subtitle = subtitle) +
    theme_modern() +
    theme(
      plot.title = element_text(face = "bold", hjust = 0.5),
      plot.subtitle = element_text(face = "italic", hjust = 0.5),
      axis.title.x = element_blank(),
      axis.title.y = element_blank(),
      axis.text.y = element_blank()
    )
}

plot_waffle <- function(dfsub, what = "Nationality", title = what) {
  ggwaffle::waffle_iron(dfsub, what) |>
    # mutate(label = emojifont::fontawesome('fa-person')) |>
    ggplot(aes(x, y, fill = group)) +
    ggwaffle::geom_waffle() +
    coord_equal() +
    ggtitle(title) +
    labs(fill = "") +
    theme_void() +
    theme(plot.title = element_text(face = "bold", hjust = 0.5))
}
```

```{r fig.width=20, fig.height=15}
# p1 <- plot_distribution(dfsub, "Age", fill = "#FF9800")
# p2 <- plot_distribution(dfsub, "Duration", title = "Total Duration", subtitle = "in minutes", fill = "#F44336")
# p3 <- plot_distribution(dfsub, "Break_Duration", title = "Break Duration", subtitle = "in minutes", fill = "#3F51B5")

p4 <- plot_waffle(dfsub, "Sex") +
  scale_fill_manual(values = c("Male" = "#2196F3", "Female" = "#E91E63", "Other" = "#FF9800"))

p5 <- plot_waffle(dfsub, "Sexual_Orientation")


p5 <- plot_waffle(dfsub, "Education") +
  scale_fill_viridis_d()

p6 <- plot_waffle(dfsub, "Nationality") +
  scale_fill_manual(values = c("South American" = "#FF5722", "Middle Eastern" = "#FF9800", "Western" = "#2196F3", "Eastern" = "#673AB7", "African" = "#4CAF50", "South African" = "#009688"))

p7 <- plot_waffle(dfsub, "Ethnicity") +
  scale_fill_manual(values = c("Latino" = "#FF5722", "Asian" = "#FF9800", "Caucasian" = "#2196F3", "African" = "#4CAF50", "Jewish" = "#9C27B0", "Mixed" = "#795548"))

p8 <- plot_waffle(dfsub, "Screen_Resolution", title = "Screen Resolution") +
  scale_fill_pizza_d() +
  guides(fill = "none")

p9 <- plot_waffle(dfsub, "Device_OS", title = "Device OS") +
  scale_fill_bluebrown_d()

# p10 <- plot_waffle(dfsub, "Screen_Refresh") +
#   scale_fill_viridis_d()


(p1 / p2 / p3) | (p4 / p5 / p9) | (p6 / p7 / p8)
```

## Results


### Reality and Attractiveness

```{r message=FALSE, warning=FALSE}
model <- glmmTMB::glmmTMB(Real ~ Attractive + (1|Participant), data = df)
```

```{r message=FALSE, warning=FALSE}
pred <- estimate_relation(model, at = c("Attractive"))

df |> 
  ggplot(aes(x = Attractive, y = Real)) +
  geom_point() +
  geom_ribbon(data = pred, aes(y = Predicted, ymin = CI_low, ymax = CI_high), alpha = 0.5) +
  geom_line(data = pred, aes(y = Predicted))
```
